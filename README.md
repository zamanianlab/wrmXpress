<img src="img/logo/output.png" alt="hex" align = "left" width="130" />


<br>  
<br>  
<br>  
<br>  
<br>  
<br>  
 
# Overview
This package contains a variety of Python modules and CellProfiler pipelines used for the analysis of worm imaging data. Some of these are specific to Zamanian lab experimental pipelines, but many of the modules should be robust to a diversity of species and experimental procedures.

# Installation and usage

The Zamanian lab run all analyses on a node at the [Center for High-Throughput Computing at UW-Madison](https://chtc.cs.wisc.edu). A Docker imaging containing all the dependendenies can be found in our [Docker GitHub repo](https://github.com/zamanianlab/Docker/tree/main/chtc-imgproc). A conda environment file has also been provided at `local_env/conda_env.yml`.

Activate the Docker/conda environment, clone the repository, update the YAML and run: `python wrmXpress.py {path/to/parameters.yml} {name of plate directory}`

# Structure
Pipeline parameters are provided in a YAML file (a template can be found at `local_env/parameters_template.yml`). Root keys include: `species`, `stages`, `modules`, `wells`, and `directories`. `modules` contains a key for each possible module, including CellProfiler. Modules are invoked by setting the value of `run` to `True`; additional module-specific parameters may apply.

# Modules

## Python modules

### motility

A Python implementation of CV2's dense flow algorithm. Requires video input. Thumbnails of flow output are generated by `dx`.

<img src="img/flow_dx.png" alt="flow" align = "center" width="400" />

### convert

Converts the default MetaXpress directory structure (images grouped by time point) into a structure that allows for video generation (grouped by well). Automatically invoked when using the motility module. `save_video` can be set to true to save the directory structure to `output`, and `rescale_multiplier` can be set to any float in order to shrink the images (for smaller video sizes).

### segment

Segments worms using a combination of Sobel and Gaussian filters. Has been tested with microfilaria, nematode larvae and adults, and schistosome adults (with some modification). Can be run on multiple wavelengths and with multi-site images. Thumbnails of segmented worms are generated by `dx`.

<img src="img/segment_dx.png" alt="segment" align = "center" width="400" />

### dx

Generates a plate-shaped thumbnail of each wavelength, as well as diagnostic images from certain modules.

<img src="img/wormsize_dx.png" alt="wormsize" align = "center" width="400" />

## CellProfiler pipelines

### mf_celltox

Measures dead microfilaria via fluorescent staining. Compatible with multi-site images. Untested for other worms/stages, but is likely to work out-of-the-box.

### feeding

Measures fluorescence in two channels. Specifically used for _C. elegans_ feeding assays, but likely to work with slight modification for any _C. elegans_ assay that seeks to measure worm fluorescence in multiple channels.

<img src="img/feeding.png" alt="feeding" align = "center" width="400" />

### wormsize

Generic pipeline for measuring the size of worms. Has been tested with mixed stages of _C. elegans_; may work with parasites. Incorporates the worm untangling and straightening algorithms from the [Worm Toolbox](https://doi.org/10.1038/nmeth.1984).

<img src="img/straightened.png" alt="straightened" align = "center" width="400" />

### wormsize_trans

Implementation of `wormsize` that also measures worm fluorescence in a single wavelength. Useful for filtering for transgenic worms containing a fluorescent marker.

# Issues

Please use the provided issue template when submitting a bug report.
