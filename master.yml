########################################
######### INSTRUMENT SETTINGS  #########
########################################

# Define source / nature of data
file_structure:
  - imagexpress # generated by IX instrument
  #- avi # single avi file of 1 or more wells

imaging_mode:
  - single-well # one image/frame for each well
  # - multi-well # one image/frame contains multiple wells
  # - multi-site # > 1 image site for each well 


########################################
### PREPROCESSING MULTI-WELL IMAGES  ###
########################################

# Physical plate dimensions
well-row: 8 # true count of wells in row
well-col: 12 # true count of wells in column

# If multi-well is flagged
multi-well-row: 1 # recorded plate rows
multi-well-col: 1 # recorded plate columns
multi-well-detection: grid # grid just divides evenly across whole image

# If multi-site is flagged (assumption: connected rectangle and s1 convention for order) - IX
x-sites: NA # sites on the x axis
y-sites: NA # sites on the y axis
stitch: False

# Required for imaging_mode: multi-well
  # Case 1: whole-plate image (e.g., avi) cut into a defined grid (e.g., 6*4 = 24 wells)
  # Case 2: images tiled across plate (e.g., 12*8 = 96 images) cut into a smaller grid (e.g., 24*16 = 384)
  # Notes: Metadata must match final plate dimensions at well level (after this processing steps


######################################
######### RUN-TIME SETTINGS  #########
######################################

# Run on 'All' or specific subset of wells
# Can't just be based on HTD file if Case 2 above
wells:
  - All
  # - A01
  # - A02

directories:
  work:
    - work
  input:
    - input
  output:
    - output


########################################
### UNIVERSAL IMAGE TRANSFORMATIONS ####
########################################

# Apply circular mask (radius: fraction of image height)
# If circle_diameter is NA, do not apply mask
# False/NA (default), True/0.4 (B. malayi WormViz adults), True/0.476 (S. mansoni adults), True/0.45 (fecundity)
circle_diameter: NA

# Apply square mask (square side: fraction of image height)
# If square_side is NA, do not apply mask
square_side: NA

# Other transformations (e.g., light corrections)

# is there already a mask in cp pipeline?


########################################
#### PIPELINE SELECTION ######
########################################

pipelines:
# Modules reflect pipelines with specific input requirements

#### Diagnostics ####
# Returns stiched images of first timepoint across all wavelengths
  static_dx:
    run: False
    rescale_multiplier: 1

# Returns video (all timepoints) across all wavelengths
# If 'All' you return a stitched video
# If individual well are selected, you return individual well videos
  video_dx:
    run: False
    format: avi / gif
    rescale_multiplier: 0.5

#### Motilty (optical flow) ####
# Requirements: single wavelength, more than 1 timepoint
  optical_flow:
    run: False
    # Specify the wavelength to run the optical flow on. If specifying multiple wavelengths, list wavelengths on a single line separated with commas (i.e. 'w1', 'w2', "w3", etc.)
    wavelengths:
      - 'All'
    flow:
    # Specifies the images scale to build pyramids for each image
    pyrScale: 0.5
    # Number of extra layers
    levels: 5
    # Average window size
    winsize: 20
    # Number of iterations to be performed at each pyramid level
    iterations: 7
    # Size of pixel neighbourhood which is used to find polynomial expansion between the pixels
    poly_n: 5
    # Standard deviation of the gaussian that is for derivatives to be smooth as the basis of polynomial expansion
    poly_sigma: 1.1
    flags: 0

#### Segmentation ####
  segmentation:
    run: True
    # Model name. If model type is 'python', leave the model blank 
    model: 'celegans_20220830'
    # Model type: 'python' or 'cellpose'
    model_type: 'cellpose'
    # If using Python as model_type, set the sigma for the kernel of the Guaussian blur
    model_sigma: 0.25
    # Specify the wavelength to run the segmentation on. If specifying multiple wavelengths, list wavelengths on a single line separated with commas (i.e. 'w1', 'w2', "w3", etc.)
    wavelengths:
      - 'All'

#### CellProfiler ####
  cellprofiler:
    run: True
    # Cellpose model. If running a cellprofiler pipeline that does not require cellpose, leave the cellpose model blank
    cellpose_model: 'celegans_20220830'
    # Cellpose wavelength. Cellpose will only run on 1 selected wavelength 
    cellpose_wavelength: 'w1'
    # CellProfiler pipeline
    pipeline: 'wormsize_intensity_cellpose'
      ## Single wavelength pipelines ##
      # - 'mf_celltox'
      ## Multi-wavelength pipelines ##
      # - feeding

#### Tracking ####
  tracking: 
    run: False
    wavelengths: 
      - 'All'
    diameter: 15 # If objects are larger/smaller adjust diameter
    minmass: 150 # If images are noisy, increase minmass
    noisesize: 1 
    searchrange: 10 #if objects move quickly between frames, increase searchrange
    memory: 5 # If objects frequently disappear/reappear, increase memory
    adaptivestop: 0.05









