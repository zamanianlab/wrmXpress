########################################
######### INSTRUMENT SETTINGS  #########
########################################

# Define source / nature of data
file_structure:
  - imagexpress # generated by IX instrument
  #- avi # single avi file of 1 or more wells

imaging_mode:
  - single-well # one image/frame for each well
  # - multi-well # one image/frame contains multiple wells
  # - multi-site # > 1 image site for each well 
# stitching: connected rectangle and convention for s# labeling
# - otherwise donâ€™t stitch the sites and process them independently


# Note, force _w1 if none
# select pipelines to run on individual wavelengths?
# w1 = bf -> w2 = gfp -> w3 = red ...


########################################
### PREPROCESSING MULTI-WELL IMAGES  ###
########################################

# Physical plate dimensions
well-row: 8 # true count of wells in row
well-col: 12 # true count of wells in column

# If multi-well is flagged
multi-well-row: 1 # recorded plate rows
multi-well-col: 1 # recorded plate columns
multi-well-detection: grid # grid just divides evenly across whole image

# If multi-site is flagged (assumption: connected rectangle and s1 convention for order) - IX
x-sites: NA # sites on the x axis
y-sites: NA # sites on the y axis
stitch: False


# Required for imaging_mode: multi-well
  # Case 1: whole-plate image (e.g., avi) cut into a defined grid (e.g., 6*4 = 24 wells)
  # Case 2: images tiled across plate (e.g., 12*8 = 96 images) cut into a smaller grid (e.g., 24*16 = 384)
  # Notes: Metadata must match final plate dimensions at well level (after this processing steps


######################################
######### RUN-TIME SETTINGS  #########
######################################

# Run on 'All' or specific subset of wells
# Can't just be based on HTD file if Case 2 above
wells:
  - All
  # - A01
  # - A02

directories:
  work:
    - work
  input:
    - input
  output:
    - output


########################################
### UNIVERSAL IMAGE TRANSFORMATIONS ####
########################################

# Apply circular mask (radius: fraction of image height)
# If circle_diameter is NA, do not apply mask
# False/NA (default), True/0.4 (B. malayi WormViz adults), True/0.476 (S. mansoni adults), True/0.45 (fecundity)
circle_diameter: 0.85

# Apply square mask (square side: fraction of image height)
# If square_side is NA, do not apply mask
square_side: NA

# Other transformations (e.g., light corrections)

# is there already a mask in cp pipeline?


########################################
#### PIPELINE SELECTION ######
########################################

pipelines:
# modules reflect pipelines with specific input requirements
# selected well set

#### Diagnostics ####
# returns stiched images of first timepoint across all wavelengths
  static_dx:
    run: False
    rescale_multiplier: 1

# returns video (all timepoints) across all wavelengths
# if 'All' you return a stitched video
# if individual well are selected, you return individual well videos
  video_dx:
    run: False
    format: avi / gif
    rescale_multiplier: 0.5

#### Motilty (optical flow) ####
# requirements: single wavelength, more than 1 timepoint
  optical_flow:
    run: False
    # specifies the images cale to build pyramids for each image
    wavelengths:
      - 'All'
    flow:
    pyrScale: 0.5
    # number of extra layers
    levels: 5
    # average window size
    winsize: 20
    # number of iterations to be performed at each pyramid level
    iterations: 7
    # size of pixel neighbourhood which is used to find polynomial expansion between the pixels
    poly_n: 5
    # standard deviation of the gaussian that is for derivatives to be smooth as the basis of polynomial expansion
    poly_sigma: 1.1
    flags: 0

#### Segmentation ####
  segmentation:
    run: True
    # model name and type
    model: '20220830_all'
    model_type: 'cellpose'
    # specify the wavelength to run the segmentation on
    wavelengths:
      - 'All'

#### CellProfiler ####
  cellprofiler:
    run: True
    # cellpose model
    cellpose_model: '20220830_all'
    # cellpose wavelength
    cellpose_wavelength: 'w1'
    # CellProfiler pipeline
    pipeline: 'wormsize_intensity_cellpose'
      ## single wavelength pipelines ##
      # - 'mf_celltox'
      ## multi-wavelength pipelines ##
      # - feeding

#### Tracking ####
  tracking: 
    run: False
    

# each pipeline is a single python script
# each pipeline is self-contained (different folders in work and output)
# each pipeline can be invoked in parallel within the wrapper
